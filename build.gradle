import groovy.io.FileType

// now run
// groovy dependencies.groovy '.*acquisition.*' && dot tmp.gv -Tsvg > tmp.svg

task createDependencyGraph(type: CreateDependencyGraph) {
	List<File> pomFiles = []
	new File(rootDirOfProjectToSearch).eachFile(FileType.DIRECTORIES) { module ->
	    pomFiles << new File(module.absolutePath + '/pom.xml')
	}

	dependenciesGroupedByModule = new MavenDependencyRetriever().parseMatchingDependenciesFromPoms(pomFiles, dependencyRegex)
}

class CreateDependencyGraph extends DefaultTask {
	@Input
	Map<String, Set<String>> dependenciesGroupedByModule

	@OutputFile
	File graphDotFile = new File("tmp.gv")

	@TaskAction
	void createDotfile() {
		def graphEntries = new DependencyToDotLanguageTranslator().translateDependenciesToDotLanguage(dependenciesGroupedByModule)

		new GraphvizDotfileCreator().createDirectedGraphFile(graphDotFile, graphEntries)
	}
}